<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Image</title>

    <!-- 引用cornerstone库 -->
    <script src="https://unpkg.com/cornerstone-core@2.6.1/dist/cornerstone.js"></script>
    <!-- 引用dicomParser库 -->
    <script src="https://unpkg.com/dicom-parser@1.8.21/dist/dicomParser.min.js"></script>
    <!-- 引用图像加载器插件（需要使用上面两个库） -->
    <script
        src="https://unpkg.com/cornerstone-wado-image-loader@4.13.2/dist/cornerstoneWADOImageLoader.bundle.min.js"></script>
</head>

<body>
    <div>
        <h1>Display Image</h1>
        <div id="dicomImage" style="width:512px;height:512px"></div>
        <div id="imagePlaneModule"></div>
    </div>

    <script>
        // 配置cornerstoneWADOImageLoader
        cornerstoneWADOImageLoader.external.dicomParser = dicomParser;
        cornerstoneWADOImageLoader.external.cornerstone = cornerstone;

        // 获取元素
        const element = document.getElementById('dicomImage');
        // 启用元素
        cornerstone.enable(element);
        // 图像ID（图像加载器:URL）
        const imageId = 'wadouri:http://localhost:5500/extensions/seu-ohif-first-extension/docs/cornerstone-learn/testdcm/ImageFileName0081.dcm';
        // 加载图像 + 显示图像
        cornerstone.loadImage(imageId).then(function (image) {
            cornerstone.displayImage(element, image);

            // 定义视区
            var viewport = {
                invert: false,  // 灰度取反
                pixelReplication: false,
                voi: {
                    windowWidth: 400,
                    windowCenter: 200
                },
                scale: 1.4,  // 图像大小比例
                translation: {  // 相对坐标偏移
                    x: 0,
                    y: 0
                },
                //colormap: 'hot'
            };
            // 设置视区
            cornerstone.setViewport(element, viewport);
            // 更新图像
            cornerstone.updateImage(element);
        });

        // 像素坐标系
        // $(element).on('cornerstoneimagerendered', (e) => {
        //     this.cornerstone.setToPixelCoordinateSystem(e.detail.enabledElement, e.detail.canvasContext);
        //     let context = e.detail.canvasContext

        //     //save canvas settings
        //     context.save()

        //     context.strokeStyle = 'green'
        //     context.beginPath()
        //     context.lineWidth = 1 / e.detail.viewport.scale
        //     context.strokeRect(100, 100, 100, 100)

        //     //restore canvas settings to previous state
        //     context.restore()
        // })

        // 定义元数据提供函数
        function metaDataProvider(type, imageId) {
            if (type === 'imagePlaneModule') {
                if (imageId === 'wadouri:http://localhost:5500/extensions/seu-ohif-first-extension/docs/cornerstone-learn/testdcm/ImageFileName0081.dcm') {
                    return {
                        frameOfReferenceUID: "1.3.6.1.4.1.5962.99.1.2237260787.1662717184.1234892907507.1411.0",
                        rows: 512,
                        columns: 512,
                        rowCosines: {
                            x: 1,
                            y: 0,
                            z: 0
                        },
                        columnCosines: {
                            x: 0,
                            y: 1,
                            z: 0
                        },
                        imagePositionPatient: {
                            x: -250,
                            y: -250,
                            z: -399.100006
                        },
                        rowPixelSpacing: 0.976562,
                        columnPixelSpacing: 0.976562
                    };
                }
            }
        }
        // 将元数据提供函数注册到cornerstone
        cornerstone.metaData.addProvider(metaDataProvider);
        // 获取图像元数据（调用元数据提供函数）
        const imagePlaneModule = cornerstone.metaData.get('imagePlaneModule', imageId);
        // 显示
        alert(JSON.stringify(imagePlaneModule));
    </script>
</body>

</html>
